---
name: Check for Applet Updates

on:
  schedule:
  - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/check-applet-updates.yml'

permissions:
  contents: write
  actions: write

jobs:
  check:
    name: Check for Applet Updates
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends git jq ca-certificates

      - name: Determine Force Check
        id: force
        run: |
          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            echo "force=true" >> $GITHUB_OUTPUT
          else
            echo "force=false" >> $GITHUB_OUTPUT
          fi

      - name: Define Applets
        id: applets
        run: |
          APPLET_JSON=$(jq -n '[
            {name: "cosmic-ext-applet-emoji-selector", url: "https://github.com/leb-kuchen/cosmic-ext-applet-emoji-selector"},
            {name: "cosmic-ext-applet-privacy-indicator", url: "https://github.com/D-Brox/cosmic-ext-applet-privacy-indicator"},
            {name: "cosmic-ext-applet-vitals", url: "https://github.com/Coinio/cosmic-ext-applet-vitals.git"},
            {name: "cosmic-applet-music-player", url: "https://github.com/Ebbo/cosmic-applet-music-player.git"},
            {name: "cosmic-ext-applet-caffeine", url: "https://github.com/tropicbliss/cosmic-ext-applet-caffeine"},
            {name: "cosmic-connect-applet", url: "https://github.com/cosmic-utils/cosmic-connect-applet.git"},
            {name: "cosmic-ext-applet-ollama", url: "https://github.com/cosmic-utils/cosmic-ext-applet-ollama"},
            {name: "cosmic-ext-applet-clipboard-manager", url: "https://github.com/cosmic-utils/clipboard-manager"}
          ]')
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          printf '%s\n' "$APPLET_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Detect New Applets and Trigger Builds
        id: check_applets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -eoux pipefail
          CHANGES_MADE=false
          FORCE_CHECK='${{ steps.force.outputs.force }}'
          APPLET_LIST='${{ steps.applets.outputs.matrix }}'

          # Get previous applet list from git to detect new additions
          if [ "${FORCE_CHECK}" == "true" ]; then
            # Force check means check all applets
            NEW_APPLETS=$(echo "${APPLET_LIST}" | jq -r '.[].name')
          else
            # Get previous version of this file to detect new applets
            PREVIOUS_FILE=$(git show HEAD~1:.github/workflows/check-applet-updates.yml 2>/dev/null || echo "")
            if [ -n "$PREVIOUS_FILE" ]; then
              # Extract applet names from previous file
              PREVIOUS_APPLETS=$(echo "$PREVIOUS_FILE" | grep -A 20 "APPLET_JSON=" | grep "name:" | sed 's/.*name: "\([^"]*\)".*/\1/' | sort | tr '\n' ' ')
              CURRENT_APPLETS=$(echo "${APPLET_LIST}" | jq -r '.[].name' | sort | tr '\n' ' ')
              
              # Find applets that are new (in current but not in previous)
              NEW_APPLETS=""
              for applet in $CURRENT_APPLETS; do
                if ! echo "$PREVIOUS_APPLETS" | grep -wq "$applet"; then
                  NEW_APPLETS="$NEW_APPLETS $applet"
                fi
              done
              NEW_APPLETS=$(echo "$NEW_APPLETS" | xargs -n1 | sort | xargs) # Sort and clean up
            else
              # No previous file, treat all as new
              NEW_APPLETS=$(echo "${APPLET_LIST}" | jq -r '.[].name')
            fi
          fi

          echo "New applets detected: $NEW_APPLETS"

          # Get list of applets with successful builds (have artifacts)
          SUCCESSFUL_APPLETS=$(gh run list --workflow build-applet.yml --limit 50 --json conclusion,name -q '.[] | select(.conclusion == "success") | .name | split(" ") | .[1]' | sort | uniq | tr '\n' ' ')

          for row in $(echo "${APPLET_LIST}" | jq -r '.[] | @base64'); do
            _jq() {
              echo ${row} | base64 --decode | jq -r ${1}
            }
            APPLET_NAME=$(_jq '.name')
            APPLET_URL=$(_jq '.url')

            # Skip if this is not a new applet and we're not forcing
            if [ "${FORCE_CHECK}" != "true" ] && ! echo "$NEW_APPLETS" | grep -wq "$APPLET_NAME"; then
              echo "${APPLET_NAME} is not new, skipping"
              continue
            fi

            echo "::group:: Checking ${APPLET_NAME}"
            LATEST_COMMIT=$(git ls-remote "${APPLET_URL}" HEAD | awk '{print $1}')
            CURRENT_COMMIT=$(jq -r ".[\"${APPLET_NAME}\"] // \"\"" build/applet-versions.json)

            # Check if this applet has a successful build (artifact exists)
            if echo "$SUCCESSFUL_APPLETS" | grep -wq "$APPLET_NAME"; then
              HAS_ARTIFACT=true
            else
              HAS_ARTIFACT=false
            fi

            if [ "${HAS_ARTIFACT}" == "true" ] && [ "${LATEST_COMMIT}" == "${CURRENT_COMMIT}" ]; then
              echo "${APPLET_NAME} is up to date and has artifact. Skipping."
              echo "::endgroup::"
              continue
            fi

            echo "Triggering build for ${APPLET_NAME}"
            CHANGES_MADE=true

            # Update version
            jq ".[\"${APPLET_NAME}\"] = \"${LATEST_COMMIT}\"" build/applet-versions.json > applet-versions.tmp && mv applet-versions.tmp build/applet-versions.json

            # Trigger build workflow
            curl -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$GITHUB_REPOSITORY/dispatches \
              -d '{"event_type":"build-applet","client_payload":{"applet_name":"'"$APPLET_NAME"'","applet_url":"'"$APPLET_URL"'"}}'

            echo "::endgroup::"
          done

          echo "changes_made=${CHANGES_MADE}" >> $GITHUB_OUTPUT

      - name: Commit Updated Versions
        if: steps.check_applets.outputs.changes_made == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci(applets): Update applet versions"
          file_pattern: "build/applet-versions.json"
