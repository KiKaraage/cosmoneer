---
name: niri_window_buttons Update

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
  push:
    branches: [main]
  workflow_dispatch:
  repository_dispatch:
    types: [build-niri-window-buttons]
  workflow_run:
    workflows: ["Applet Management"]
    types:
      - completed
    branches: [main]

permissions:
  contents: write
  actions: write

jobs:
  check-update:
    name: Check for niri_window_buttons Update
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request'

    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends git jq ca-certificates

      - name: Check for Update
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -eoux pipefail
          
          REPO_URL="https://github.com/adelmonte/niri_window_buttons.git"
          CURRENT_VERSION=$(jq -r '.niri_window_buttons // ""' build/applet-versions.json)
          
          echo "Current version: $CURRENT_VERSION"
          
          # Check if there's a new release
          LATEST_RELEASE=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/adelmonte/niri_window_buttons/releases/latest | \
            jq -r '.tag_name // empty')
          
          if [ -n "$LATEST_RELEASE" ]; then
            echo "Latest release: $LATEST_RELEASE"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST_RELEASE" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            # Fallback to checking HEAD commit if no releases
            LATEST_COMMIT=$(git ls-remote "$REPO_URL" HEAD | awk '{print $1}')
            echo "Latest commit: $LATEST_COMMIT"
            
            if [ "$LATEST_COMMIT" != "$CURRENT_VERSION" ]; then
              echo "has_update=true" >> $GITHUB_OUTPUT
              echo "new_version=$LATEST_COMMIT" >> $GITHUB_OUTPUT
              echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            else
              echo "has_update=false" >> $GITHUB_OUTPUT
              echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
              echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Update Version and Commit
        if: steps.check.outputs.has_update == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci(applets): Update niri_window_buttons to ${{ steps.check.outputs.new_version }}"
          file_pattern: "build/applet-versions.json"
          push_options: --force-with-lease

  build-niri-window-buttons:
    name: Build niri_window_buttons
    runs-on: ubuntu-24.04
    needs: check-update
    if: needs.check-update.outputs.has_update == 'true' && github.event_name != 'pull_request'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cargo build-essential git gcc g++ make \
            libxkbcommon-dev libpipewire-0.3-dev libdbus-1-dev \
            libssl-dev pkg-config libwayland-dev ca-certificates \
            libglib2.0-dev libgtk-3-dev \
            just unzip

      - name: Build niri_window_buttons
        run: |
          set -eoux pipefail
          REPO_URL="https://github.com/adelmonte/niri_window_buttons.git"
          REPO_DIR="/tmp/niri_window_buttons"
          
          echo "::group:: Building niri_window_buttons"
          
          # Clean and clone
          rm -rf "${REPO_DIR}"
          git clone --depth 1 "${REPO_URL}" "${REPO_DIR}"
          
          cd "${REPO_DIR}"
          
          # Build with timeout
          timeout 600 cargo build --release
          
          # Create artifact directory
          mkdir -p /tmp/artifacts/niri_window_buttons
          
          # Copy the .so file directly
          if [ -f "target/release/libniri_window_buttons.so" ]; then
            cp "target/release/libniri_window_buttons.so" "/tmp/artifacts/niri_window_buttons/"
            echo "Copied libniri_window_buttons.so to artifacts"
          else
            echo "::error:: libniri_window_buttons.so not found in target/release/"
            ls -la target/release/
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: niri_window_buttons
          path: /tmp/artifacts/niri_window_buttons/
          retention-days: 30

  check-existing-artifacts:
    name: Check Existing Artifacts
    runs-on: ubuntu-24.04
    needs: check-update
    if: needs.check-update.outputs.has_update == 'false' && github.event_name != 'pull_request'

    steps:
      - name: Check for Latest Successful Artifact
        uses: actions/github-script@v7
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               workflow_id: 'niri_window_buttons Update',
               run_id: process.env.GITHUB_RUN_ID,
            });
            
            const niriArtifact = artifacts.find(artifact => artifact.name === 'niri_window_buttons');
            
            if (niriArtifact) {
              console.log('✅ Found existing niri_window_buttons artifact');
              console.log(`Artifact ID: ${niriArtifact.id}`);
              console.log(`Artifact size: ${niriArtifact.size_in_bytes} bytes`);
              console.log(`Created at: ${niriArtifact.created_at}`);
            } else {
              console.log('❌ No niri_window_buttons artifact found');
            }